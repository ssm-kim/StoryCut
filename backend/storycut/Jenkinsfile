pipeline {
    agent {
        label 'jenkins-agent'
    }

    environment {
        IMAGE_NAME = 'jiwon9559/storycut'      // Docker ì´ë¯¸ì§€ ì •ë³´
        TAG = 'latest'
        DEPLOY_SERVER = 'k12d108.p.ssafy.io'
        DEPLOY_USER = 'ubuntu'
        DEPLOY_PATH = '/home/ubuntu/deploy/app'
        JAVA_HOME = '/usr/lib/jvm/java-17-openjdk-amd64'
        PATH = "${env.JAVA_HOME}/bin:${env.PATH}"
        SECRET_YML = credentials('SPRINGBOOT_APPLICATION_SECRET_YML')
    }

    /*
        ì£¼ìš” ê¸°ëŠ¥
        1. GitLabì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        2. ./gradlew build ë¡œ JAR íŒŒì¼ ë¹Œë“œ
        3. Docker ì´ë¯¸ì§€ ë¹Œë“œ
        4. Docker Hubì— ë¡œê·¸ì¸ í›„ ì´ë¯¸ì§€ í‘¸ì‹œ
        5. ë°°í¬
    */

    stages {

        // 1. GitLabì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ(GitLab ì €ì¥ì†Œì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜´)
        stage('Chekout') {
            steps {
                checkout scm
            }
        }

        // 2. application-secret.yml ìƒì„±
        stage('Write application-secret.yml'){
            steps {
                script{
                    dir('backend/storycut/src/main/resources') {
                        // base64 ì¸ì½”ë”©ëœ ë¬¸ìì—´ì„ .b64 íŒŒì¼ë¡œ ì €ì¥
                        writeFile file: 'application-secret.yml.b64', text: "${env.SECRET_YML}"

                        // base64 ë””ì½”ë”© í›„ ì›ë˜ YAML ë³µì›
                        sh 'base64 -d application-secret.yml.b64 > application-secret.yml'

                        // ë³´ì•ˆìƒ .b64 íŒŒì¼ ì‚­ì œ
                        sh 'rm -f application-secret.yml.b64'

                        // ì •ìƒ ìƒì„± ì—¬ë¶€ í™•ì¸
                        sh 'test -f application-secret.yml && echo "âœ… YAML ìƒì„± ì™„ë£Œ" || echo "âŒ YAML ìƒì„± ì‹¤íŒ¨"'
                    }
                }
            }
        }

        // 3. JAR íŒŒì¼ ë¹Œë“œ (Gradle ë¹Œë“œ)
        stage('Build') {
            steps {
                dir('backend/storycut') {
                    // gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                    sh 'chmod +x ./gradlew'
                    // Gradle ë¹Œë“œ ì‹¤í–‰
                    sh './gradlew clean build -x test'
                }
            }
        }

        // 4. ./gradlew buildë¡œ JAR íŒŒì¼ ë¹Œë“œ
        stage('Build Docker Image'){
            steps {
                dir('backend/storycut') {
                    // build-argë¥¼ ì´ìš©í•´ jar íŒŒì¼ì„ ì „ë‹¬í•˜ê³  Docker Hub í‘¸ì‹œ ì¤€ë¹„
                    echo "ë©€í‹° ìŠ¤í…Œì´ì§€ Dockerfileì„ ì´ìš©í•´ ì´ë¯¸ì§€ ë¹Œë“œ"
                    sh 'docker build -t $IMAGE_NAME:$TAG .'
                }
            }
        }

        // 5. Docker Hubì— ë¡œê·¸ì¸ í›„ ì´ë¯¸ì§€ í‘¸ì‹œ
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-hub',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push $IMAGE_NAME:$TAG
                    '''
                }
            }
            post {
                always {
                    sh 'rm -f backend/storycut/src/main/resources/application-secret.yml'
                    // ë¡œê·¸ì•„ì›ƒì„ í•˜ëŠ” ì´ìœ : ë³´ì•ˆ ìœ ì§€ ëª©ì 
                    sh 'docker logout'
                }
            }
        }

        // 6. ë°°í¬
        stage('Deploy to EC2') {
            steps {
                sshagent(credentials: ['ec2-ssh-key']) {
                    sh(script: """
                        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER << EOF
                        cd /home/ubuntu/data
                        docker pull $IMAGE_NAME:$TAG
                        docker compose up -d
                        EOF
                    """, returnStatus: true)
                }
            }
        }
    }

    post {
        success {
            script {
                def fullBranch = sh(script: 'git name-rev --name-only HEAD', returnStdout: true).trim()
                def gitBranch = fullBranch.replaceAll('remotes/origin/', '').replaceAll('refs/heads/', '')
                def gitCommit = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                def commitMsg = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                def commitAuthor = sh(script: 'git log -1 --pretty=%an', returnStdout: true).trim()
                def koreaTime = new Date(System.currentTimeMillis() + 9 * 60 * 60 * 1000)
                def formattedTime = koreaTime.format('yyyy-MM-dd HH:mm')

                mattermostSend(
                    endpoint: 'https://meeting.ssafy.com/hooks/w66jd49smjdwzeg35edab7j6ce',
                    channel: 'D108-Jenkins',
                    icon: ':rocket:',
                    color: '#36a64f',
                    message: "**âœ… Spring Boot ë¹Œë“œ ì„±ê³µ!**\n" +
                            "--------------------------------------------------\n" +
                            "*Branch*: ${gitBranch} \n" +
                            "*Commit*: ${gitCommit} - ${commitMsg} \n" +
                            "*Author*: ${commitAuthor}\n" +
                            "*Build Time*: ${formattedTime}\n" +

                            "ğŸ§¾[ë¹Œë“œ ë¡œê·¸ í™•ì¸](${env.BUILD_URL})\n" +
                            "âœ”ï¸[ì†ŒìŠ¤ ì½”ë“œ ë³€ê²½ì‚¬í•­](${env.BUILD_URL}changes)\n " +
                            "ğŸ“ˆ[íŠ¸ë Œë“œ ë³´ê¸°](${env.BUILD_URL}trend)"
                )
            }
        }
        failure {
            script {
                def fullBranch = sh(script: 'git name-rev --name-only HEAD', returnStdout: true).trim()
                def gitBranch = fullBranch.replaceAll('remotes/origin/', '').replaceAll('refs/heads/', '')
                def gitCommit = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                def commitMsg = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                def commitAuthor = sh(script: 'git log -1 --pretty=%an', returnStdout: true).trim()
                def koreaTime = new Date(System.currentTimeMillis() + 9 * 60 * 60 * 1000)
                def formattedTime = koreaTime.format('yyyy-MM-dd HH:mm')

                mattermostSend(
                    endpoint: 'https://meeting.ssafy.com/hooks/w66jd49smjdwzeg35edab7j6ce',
                    channel: 'D108-Jenkins',
                    icon: ':fire:',
                    color: '#e01e5a',
                    message: "**âŒ Spring Boot ë¹Œë“œ ì‹¤íŒ¨**\n" +
                            "--------------------------------------------------\n" +
                            "*Branch*: ${gitBranch} \n" +
                            "*Commit*: ${gitCommit} - ${commitMsg} \n" +
                            "*Author*: ${commitAuthor}\n" +
                            "*Build Time*: ${formattedTime}\n" +

                            "ğŸ§¾[ë¹Œë“œ ë¡œê·¸ í™•ì¸](${env.BUILD_URL})\n" +
                            "âœ”ï¸[ì†ŒìŠ¤ ì½”ë“œ ë³€ê²½ì‚¬í•­](${env.BUILD_URL}changes)\n " +
                            "ğŸ“ˆ[íŠ¸ë Œë“œ ë³´ê¸°](${env.BUILD_URL}trend)"
                )
            }
        }
    }
}